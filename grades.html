<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>My Canvas Courses &amp; Final Grades</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      padding: 30px;
    }
    input {
      width: 500px;
      padding: 10px;
      font-size: 16px;
    }
    button {
      padding: 10px 18px;
      font-size: 16px;
      margin-left: 10px;
    }
    .course-box {
      margin-top: 30px;
      border-top: 1px solid #444;
      padding-top: 20px;
    }
    .course-header {
      font-size: 22px;
      margin-bottom: 6px;
    }
    .final-grade {
      font-size: 18px;
      color: #7fff7f; /* light green */
      margin-bottom: 10px;
    }
    ul.assign-list {
      margin-left: 20px;
    }
    ul.assign-list li {
      margin-bottom: 4px;
      font-size: 18px;
    }
    #error {
      color: #ff4d4d;
      margin-top: 15px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>My Canvas Courses &amp; Final Grades</h1>

  <input id="token" placeholder="Paste your Canvas access token here" />
  <button onclick="fetchCourseAssignments()">Fetch All</button>
  <p id="error"></p>

  <div id="results"></div>

  <script>
    async function fetchCourseAssignments() {
      const token = document.getElementById('token').value.trim();
      const resultsDiv = document.getElementById('results');
      const errorP = document.getElementById('error');
      resultsDiv.innerHTML = '';
      errorP.textContent = '';

      if (!token) {
        errorP.textContent = 'You need to paste your access token first.';
        return;
      }

      try {
        console.log('-> Sending request to proxy…');
        console.log('   Token:', token);

        const response = await fetch(
          'https://canvas-proxy-kqgrxluqm-ilyambrrs-projects.vercel.app/api/grades',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token }),
          }
        );

        console.log('   Raw response object:', response);

        if (!response.ok) {
          const text = await response.text();
          console.error('   Proxy returned error text:', text);
          throw new Error('Invalid token or proxy failed');
        }

        const coursesArray = await response.json();
        console.log('   Parsed JSON:', coursesArray);

        if (!Array.isArray(coursesArray) || coursesArray.length === 0) {
          resultsDiv.innerHTML = '<p>No courses / assignments found.</p>';
          return;
        }

        coursesArray.forEach((courseObj) => {
          // 1) Course container
          const container = document.createElement('div');
          container.className = 'course-box';

          // 2) Header: Course Name (ID)
          const header = document.createElement('div');
          header.className = 'course-header';
          header.textContent = `${courseObj.course_name} (ID: ${courseObj.course_id})`;
          container.appendChild(header);

          // 3) Show Final Grade
          const gradeLine = document.createElement('div');
          gradeLine.className = 'final-grade';
          if (courseObj.final_grade !== null) {
            gradeLine.textContent = `Final Grade: ${courseObj.final_grade}`;
          } else {
            gradeLine.textContent = `Final Grade: N/A`;
            gradeLine.style.color = '#ffae00'; // amber if missing
          }
          container.appendChild(gradeLine);

          // 4) Assignments list (if any)
          if (
            !courseObj.assignments ||
            !Array.isArray(courseObj.assignments) ||
            courseObj.assignments.length === 0
          ) {
            const noAssign = document.createElement('div');
            noAssign.textContent = 'No assignments found for this course.';
            container.appendChild(noAssign);
          } else {
            const ul = document.createElement('ul');
            ul.className = 'assign-list';
            courseObj.assignments.forEach((assign) => {
              const li = document.createElement('li');
              li.textContent = `${assign.name} (ID: ${assign.id}) – ${assign.points_possible} pts possible`;
              ul.appendChild(li);
            });
            container.appendChild(ul);
          }

          resultsDiv.appendChild(container);
        });
      } catch (err) {
        console.error('Fetch Error:', err);
        errorP.textContent = 'Failed to fetch: ' + err.message;
      }
    }
  </script>
</body>
</html>
