<!DOCTYPE html>
<html>
<head>
  <title>My Canvas Grades</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      padding: 40px;
    }
    input {
      width: 500px;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      margin-left: 10px;
    }
    .course-section {
      margin-top: 30px;
      border-top: 1px solid #444;
      padding-top: 20px;
    }
    .course-title {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .course-grade {
      font-size: 20px;
      margin-bottom: 12px;
      color: #a0e0a0;
    }
    ul {
      list-style: disc inside;
    }
    li {
      margin-bottom: 6px;
      font-size: 18px;
    }
    #error {
      color: #ff4d4d;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>My Canvas Grades</h1>

  <input id="token" placeholder="Paste your Canvas access token here" />
  <button onclick="fetchGrades()">Fetch Grades</button>

  <p id="error"></p>
  <div id="results"></div>

  <script>
    async function fetchGrades() {
      const token = document.getElementById("token").value.trim();
      const resultsContainer = document.getElementById("results");
      const errorMsg = document.getElementById("error");

      resultsContainer.innerHTML = "";
      errorMsg.textContent = "";

      if (!token) {
        errorMsg.textContent = "You need to paste your access token first.";
        return;
      }

      try {
        console.log("üîÑ Sending request to proxy...");
        console.log("üß† Token:", token);

        const res = await fetch(
          "https://canvas-proxy-kqgrxluqm-ilyambrrs-projects.vercel.app/api/grades",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          }
        );

        console.log("üì• Response object:", res);

        if (!res.ok) {
          const text = await res.text();
          console.error("‚ùå Error response text:", text);
          throw new Error("Invalid token or proxy failed");
        }

        const data = await res.json();
        console.log("‚úÖ Parsed data:", data);

        if (!data.length) {
          resultsContainer.innerHTML = "<p>No courses or grades found.</p>";
          return;
        }

        // Loop over each course in the returned array:
        data.forEach((courseObj) => {
          // Container for this course
          const section = document.createElement("div");
          section.className = "course-section";

          // Course title
          const title = document.createElement("div");
          title.className = "course-title";
          title.textContent = courseObj.course;
          section.appendChild(title);

          // Overall Current Grade
          const gradeLine = document.createElement("div");
          gradeLine.className = "course-grade";

          // Only format a percent if current_score is a real number:
          let percentText = "";
          if (typeof courseObj.current_score === "number") {
            percentText = ` (${courseObj.current_score.toFixed(2)}%)`;
          }

          if (courseObj.current_grade !== null) {
            gradeLine.textContent =
              "Current Grade: " +
              courseObj.current_grade +
              percentText;
          } else {
            gradeLine.textContent = "Current Grade: N/A";
          }
          section.appendChild(gradeLine);

          // List of assignments
          if (courseObj.assignments && courseObj.assignments.length > 0) {
            const ul = document.createElement("ul");
            courseObj.assignments.forEach((a) => {
              const li = document.createElement("li");
              if (a.score === null) {
                li.textContent = `${a.name}: not graded yet`;
              } else {
                li.textContent = `${a.name}: ${a.score} / ${a.possible}`;
              }
              ul.appendChild(li);
            });
            section.appendChild(ul);
          } else {
            const noAssign = document.createElement("div");
            noAssign.textContent = "No assignments found for this course.";
            section.appendChild(noAssign);
          }

          resultsContainer.appendChild(section);
        });
      } catch (err) {
        console.error("‚ùó Fetch Error:", err);
        errorMsg.textContent = "Failed to fetch: " + err.message;
      }
    }
  </script>
</body>
</html>
